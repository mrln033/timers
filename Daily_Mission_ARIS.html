<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Daily Mission = A.R.I.S.</title>
<style>
body {
  font-family: Arial, sans-serif;
}
table {
  border-collapse: collapse;
  width: 100%;
  max-width: 700px;
}
th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: center;
}
button {
  padding: 4px 8px;
  cursor: pointer;
}
</style>
</head>
<body>

<h2>-= Daily Missions = A.R.I.S. =-</h2>

<table>
  <thead>
    <tr>
      <th>Mission</th>
      <th>Actif / Compteur</th>
      <th>WayPoint</th>
    </tr>
  </thead>
  <tbody id="timersTable"></tbody>
</table>

<script>
const STORAGE_KEY = "timers_state_v1";
let configTimers = [];
let state = {};

fetch("timers_aris.json")
  .then(res => res.json())
  .then(data => {
    configTimers = data;
    loadState();
    renderTimers();
    setInterval(updateTimers, 1000);
  });

function loadState() {
  const saved = localStorage.getItem(STORAGE_KEY);
  state = saved ? JSON.parse(saved) : {};
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function renderTimers() {
  const tbody = document.getElementById("timersTable");
  tbody.innerHTML = "";

  configTimers.forEach(timer => {
    if (!state[timer.id]) {
      state[timer.id] = {
        endTime: null
      };
    }

    const row = document.createElement("tr");

    const nameCell = document.createElement("td");
    nameCell.textContent = timer.name;

    const controlCell = document.createElement("td");
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";

    const counterSpan = document.createElement("span");
    counterSpan.style.marginLeft = "8px";

    if (state[timer.id].endTime) {
      checkbox.checked = true;
    }

    checkbox.addEventListener("change", () => {
      if (checkbox.checked) {
        const end = Date.now() + timer.durationHours * 3600 * 1000;
        state[timer.id].endTime = end;
      } else {
        state[timer.id].endTime = null;
      }
      saveState();
      updateTimers();
    });

    controlCell.appendChild(checkbox);
    controlCell.appendChild(counterSpan);

    const copyCell = document.createElement("td");
    const copyButton = document.createElement("button");
    copyButton.textContent = "Copier";
    copyButton.addEventListener("click", () => {
      navigator.clipboard.writeText(timer.coords);
      copyButton.textContent = "Copié !";
      setTimeout(() => copyButton.textContent = "Copier", 1000);
    });
    copyCell.appendChild(copyButton);

    row.appendChild(nameCell);
    row.appendChild(controlCell);
    row.appendChild(copyCell);

    tbody.appendChild(row);

    timer._elements = {
      checkbox,
      counterSpan
    };
  });

  saveState();
}

function updateTimers() {
  configTimers.forEach(timer => {
    const s = state[timer.id];
    const elements = timer._elements;

    if (!s.endTime) {
      elements.counterSpan.textContent = "";
      elements.checkbox.checked = false;
      return;
    }

    const remaining = s.endTime - Date.now();

    if (remaining <= 0) {
      s.endTime = null;
      elements.counterSpan.textContent = "Terminé";
      elements.checkbox.checked = false;
      saveState();
      return;
    }

    const hours = Math.floor(remaining / (1000 * 60 * 60));
    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((remaining % (1000 * 60)) / 1000);

    elements.counterSpan.textContent =
      `${hours}h ${minutes}m ${seconds}s`;
  });
}
</script>

</body>
</html>
